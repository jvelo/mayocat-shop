/**
 * messageformat.js
 *
 * ICU PluralFormat + SelectFormat for JavaScript
 *
 * @author Alex Sexton - @SlexAxton
 * @version 0.1.5
 * @license WTFPL
 * @contributor_license Dojo CLA
*/
(function(A){function MessageFormat(a,b){var c;if(a&&b){MessageFormat.locale[a]=b}c=a=a||"en";b=b||MessageFormat.locale[c=MessageFormat.Utils.getFallbackLocale(a)];if(!b){throw new Error("Plural Function not found for locale: "+a);}this.pluralFunc=b;this.locale=a;this.fallbackLocale=c}MessageFormat.locale={"en":function(n){if(n===1){return"one"}return"other"}};MessageFormat.SafeString=function(a){this.string=a};MessageFormat.SafeString.prototype.toString=function(){return this.string.toString()};MessageFormat.Utils={numSub:function(b,c,d){return b.replace(/^#|[^\\]#/g,function(m){var a=m&&m.length===2?m.charAt(0):'';return a+'" + (function(){ var x = '+c+';\nif( isNaN(x) ){\nthrow new Error("MessageFormat: `"+lastkey_'+d+'+"` isnt a number.");\n}\nreturn x;\n})() + "'})},escapeExpression:function(b){var c={"\n":"\\n","\"":'\\"'},badChars=/[\n"]/g,possible=/[\n"]/,escapeChar=function(a){return c[a]||"&amp;"};if(b instanceof MessageFormat.SafeString){return b.toString()}else if(b===null||b===false){return""}if(!possible.test(b)){return b}return b.replace(badChars,escapeChar)},getFallbackLocale:function(a){var b=a.indexOf("-")>=0?"-":"_";while(!MessageFormat.locale.hasOwnProperty(a)){a=a.substring(0,a.lastIndexOf(b));if(a.length===0){return null}}return a}};var B=(function(){function quote(s){return'"'+s.replace(/\\/g,'\\\\').replace(/"/g,'\\"').replace(/\x08/g,'\\b').replace(/\t/g,'\\t').replace(/\n/g,'\\n').replace(/\f/g,'\\f').replace(/\r/g,'\\r').replace(/[\x00-\x07\x0B\x0E-\x1F\x80-\uFFFF]/g,escape)+'"'}var z={parse:function(h,l){var m={"start":parse_start,"messageFormatPattern":parse_messageFormatPattern,"messageFormatPatternRight":parse_messageFormatPatternRight,"messageFormatElement":parse_messageFormatElement,"elementFormat":parse_elementFormat,"pluralStyle":parse_pluralStyle,"selectStyle":parse_selectStyle,"pluralFormatPattern":parse_pluralFormatPattern,"offsetPattern":parse_offsetPattern,"selectFormatPattern":parse_selectFormatPattern,"pluralForms":parse_pluralForms,"stringKey":parse_stringKey,"string":parse_string,"id":parse_id,"chars":parse_chars,"char":parse_char,"digits":parse_digits,"hexDigit":parse_hexDigit,"_":parse__,"whitespace":parse_whitespace};if(l!==undefined){if(m[l]===undefined){throw new Error("Invalid rule name: "+quote(l)+".");}}else{l="start"}var n=0;var o=0;var p=0;var q=[];function padLeft(a,b,c){var d=a;var e=c-a.length;for(var i=0;i<e;i++){d=b+d}return d}function escape(a){var b=a.charCodeAt(0);var c;var d;if(b<=0xFF){c='x';d=2}else{c='u';d=4}return'\\'+c+padLeft(b.toString(16).toUpperCase(),'0',d)}function matchFailed(a){if(n<p){return}if(n>p){p=n;q=[]}q.push(a)}function parse_start(){var c;var d;d=n;c=parse_messageFormatPattern();if(c!==null){c=(function(a,b){return{type:"program",program:b}})(d,c)}if(c===null){n=d}return c}function parse_messageFormatPattern(){var e,result1,result2;var f,pos1;f=n;pos1=n;e=parse_string();if(e!==null){result1=[];result2=parse_messageFormatPatternRight();while(result2!==null){result1.push(result2);result2=parse_messageFormatPatternRight()}if(result1!==null){e=[e,result1]}else{e=null;n=pos1}}else{e=null;n=pos1}if(e!==null){e=(function(a,b,c){var d=[];if(b&&b.val){d.push(b)}for(var i in c){if(c.hasOwnProperty(i)){d.push(c[i])}}return{type:'messageFormatPattern',statements:d}})(f,e[0],e[1])}if(e===null){n=f}return e}function parse_messageFormatPatternRight(){var e,result1,result2,result3,result4,result5;var f,pos1;f=n;pos1=n;if(h.charCodeAt(n)===123){e="{";n++}else{e=null;if(o===0){matchFailed("\"{\"")}}if(e!==null){result1=parse__();if(result1!==null){result2=parse_messageFormatElement();if(result2!==null){result3=parse__();if(result3!==null){if(h.charCodeAt(n)===125){result4="}";n++}else{result4=null;if(o===0){matchFailed("\"}\"")}}if(result4!==null){result5=parse_string();if(result5!==null){e=[e,result1,result2,result3,result4,result5]}else{e=null;n=pos1}}else{e=null;n=pos1}}else{e=null;n=pos1}}else{e=null;n=pos1}}else{e=null;n=pos1}}else{e=null;n=pos1}if(e!==null){e=(function(a,b,c){var d=[];if(b){d.push(b)}if(c&&c.val){d.push(c)}return{type:"messageFormatPatternRight",statements:d}})(f,e[2],e[5])}if(e===null){n=f}return e}function parse_messageFormatElement(){var e,result1,result2;var f,pos1,pos2;f=n;pos1=n;e=parse_id();if(e!==null){pos2=n;if(h.charCodeAt(n)===44){result1=",";n++}else{result1=null;if(o===0){matchFailed("\",\"")}}if(result1!==null){result2=parse_elementFormat();if(result2!==null){result1=[result1,result2]}else{result1=null;n=pos2}}else{result1=null;n=pos2}result1=result1!==null?result1:"";if(result1!==null){e=[e,result1]}else{e=null;n=pos1}}else{e=null;n=pos1}if(e!==null){e=(function(a,b,c){var d={type:"messageFormatElement",argumentIndex:b};if(c&&c.length){d.elementFormat=c[1]}else{d.output=true}return d})(f,e[0],e[1])}if(e===null){n=f}return e}function parse_elementFormat(){var b,result1,result2,result3,result4,result5,result6;var c,pos1;c=n;pos1=n;b=parse__();if(b!==null){if(h.substr(n,6)==="plural"){result1="plural";n+=6}else{result1=null;if(o===0){matchFailed("\"plural\"")}}if(result1!==null){result2=parse__();if(result2!==null){if(h.charCodeAt(n)===44){result3=",";n++}else{result3=null;if(o===0){matchFailed("\",\"")}}if(result3!==null){result4=parse__();if(result4!==null){result5=parse_pluralStyle();if(result5!==null){result6=parse__();if(result6!==null){b=[b,result1,result2,result3,result4,result5,result6]}else{b=null;n=pos1}}else{b=null;n=pos1}}else{b=null;n=pos1}}else{b=null;n=pos1}}else{b=null;n=pos1}}else{b=null;n=pos1}}else{b=null;n=pos1}if(b!==null){b=(function(a,t,s){return{type:"elementFormat",key:t,val:s.val}})(c,b[1],b[5])}if(b===null){n=c}if(b===null){c=n;pos1=n;b=parse__();if(b!==null){if(h.substr(n,6)==="select"){result1="select";n+=6}else{result1=null;if(o===0){matchFailed("\"select\"")}}if(result1!==null){result2=parse__();if(result2!==null){if(h.charCodeAt(n)===44){result3=",";n++}else{result3=null;if(o===0){matchFailed("\",\"")}}if(result3!==null){result4=parse__();if(result4!==null){result5=parse_selectStyle();if(result5!==null){result6=parse__();if(result6!==null){b=[b,result1,result2,result3,result4,result5,result6]}else{b=null;n=pos1}}else{b=null;n=pos1}}else{b=null;n=pos1}}else{b=null;n=pos1}}else{b=null;n=pos1}}else{b=null;n=pos1}}else{b=null;n=pos1}if(b!==null){b=(function(a,t,s){return{type:"elementFormat",key:t,val:s.val}})(c,b[1],b[5])}if(b===null){n=c}}return b}function parse_pluralStyle(){var c;var d;d=n;c=parse_pluralFormatPattern();if(c!==null){c=(function(a,b){return{type:"pluralStyle",val:b}})(d,c)}if(c===null){n=d}return c}function parse_selectStyle(){var c;var d;d=n;c=parse_selectFormatPattern();if(c!==null){c=(function(a,b){return{type:"selectStyle",val:b}})(d,c)}if(c===null){n=d}return c}function parse_pluralFormatPattern(){var e,result1,result2;var f,pos1;f=n;pos1=n;e=parse_offsetPattern();e=e!==null?e:"";if(e!==null){result1=[];result2=parse_pluralForms();while(result2!==null){result1.push(result2);result2=parse_pluralForms()}if(result1!==null){e=[e,result1]}else{e=null;n=pos1}}else{e=null;n=pos1}if(e!==null){e=(function(a,b,c){var d={type:"pluralFormatPattern",pluralForms:c};if(b){d.offset=b}else{d.offset=0}return d})(f,e[0],e[1])}if(e===null){n=f}return e}function parse_offsetPattern(){var b,result1,result2,result3,result4,result5,result6;var c,pos1;c=n;pos1=n;b=parse__();if(b!==null){if(h.substr(n,6)==="offset"){result1="offset";n+=6}else{result1=null;if(o===0){matchFailed("\"offset\"")}}if(result1!==null){result2=parse__();if(result2!==null){if(h.charCodeAt(n)===58){result3=":";n++}else{result3=null;if(o===0){matchFailed("\":\"")}}if(result3!==null){result4=parse__();if(result4!==null){result5=parse_digits();if(result5!==null){result6=parse__();if(result6!==null){b=[b,result1,result2,result3,result4,result5,result6]}else{b=null;n=pos1}}else{b=null;n=pos1}}else{b=null;n=pos1}}else{b=null;n=pos1}}else{b=null;n=pos1}}else{b=null;n=pos1}}else{b=null;n=pos1}if(b!==null){b=(function(a,d){return d})(c,b[5])}if(b===null){n=c}return b}function parse_selectFormatPattern(){var c,result1;var d;d=n;c=[];result1=parse_pluralForms();while(result1!==null){c.push(result1);result1=parse_pluralForms()}if(c!==null){c=(function(a,b){return{type:"selectFormatPattern",pluralForms:b}})(d,c)}if(c===null){n=d}return c}function parse_pluralForms(){var c,result1,result2,result3,result4,result5,result6,result7;var d,pos1;d=n;pos1=n;c=parse__();if(c!==null){result1=parse_stringKey();if(result1!==null){result2=parse__();if(result2!==null){if(h.charCodeAt(n)===123){result3="{";n++}else{result3=null;if(o===0){matchFailed("\"{\"")}}if(result3!==null){result4=parse__();if(result4!==null){result5=parse_messageFormatPattern();if(result5!==null){result6=parse__();if(result6!==null){if(h.charCodeAt(n)===125){result7="}";n++}else{result7=null;if(o===0){matchFailed("\"}\"")}}if(result7!==null){c=[c,result1,result2,result3,result4,result5,result6,result7]}else{c=null;n=pos1}}else{c=null;n=pos1}}else{c=null;n=pos1}}else{c=null;n=pos1}}else{c=null;n=pos1}}else{c=null;n=pos1}}else{c=null;n=pos1}}else{c=null;n=pos1}if(c!==null){c=(function(a,k,b){return{type:"pluralForms",key:k,val:b}})(d,c[1],c[5])}if(c===null){n=d}return c}function parse_stringKey(){var b,result1;var c,pos1;c=n;b=parse_id();if(b!==null){b=(function(a,i){return i})(c,b)}if(b===null){n=c}if(b===null){c=n;pos1=n;if(h.charCodeAt(n)===61){b="=";n++}else{b=null;if(o===0){matchFailed("\"=\"")}}if(b!==null){result1=parse_digits();if(result1!==null){b=[b,result1]}else{b=null;n=pos1}}else{b=null;n=pos1}if(b!==null){b=(function(a,d){return d})(c,b[1])}if(b===null){n=c}}return b}function parse_string(){var d,result1,result2,result3,result4;var e,pos1,pos2;e=n;pos1=n;d=parse__();if(d!==null){result1=[];pos2=n;result2=parse__();if(result2!==null){result3=parse_chars();if(result3!==null){result4=parse__();if(result4!==null){result2=[result2,result3,result4]}else{result2=null;n=pos2}}else{result2=null;n=pos2}}else{result2=null;n=pos2}while(result2!==null){result1.push(result2);pos2=n;result2=parse__();if(result2!==null){result3=parse_chars();if(result3!==null){result4=parse__();if(result4!==null){result2=[result2,result3,result4]}else{result2=null;n=pos2}}else{result2=null;n=pos2}}else{result2=null;n=pos2}}if(result1!==null){d=[d,result1]}else{d=null;n=pos1}}else{d=null;n=pos1}if(d!==null){d=(function(a,b,s){var c=[];for(var i=0;i<s.length;++i){for(var j=0;j<s[i].length;++j){c.push(s[i][j])}}return{type:"string",val:b+c.join('')}})(e,d[0],d[1])}if(d===null){n=e}return d}function parse_id(){var d,result1,result2,result3;var e,pos1;e=n;pos1=n;d=parse__();if(d!==null){if(/^[a-zA-Z$_]/.test(h.charAt(n))){result1=h.charAt(n);n++}else{result1=null;if(o===0){matchFailed("[a-zA-Z$_]")}}if(result1!==null){result2=[];if(/^[^ \t\n\r,.+={}]/.test(h.charAt(n))){result3=h.charAt(n);n++}else{result3=null;if(o===0){matchFailed("[^ \\t\\n\\r,.+={}]")}}while(result3!==null){result2.push(result3);if(/^[^ \t\n\r,.+={}]/.test(h.charAt(n))){result3=h.charAt(n);n++}else{result3=null;if(o===0){matchFailed("[^ \\t\\n\\r,.+={}]")}}}if(result2!==null){result3=parse__();if(result3!==null){d=[d,result1,result2,result3]}else{d=null;n=pos1}}else{d=null;n=pos1}}else{d=null;n=pos1}}else{d=null;n=pos1}if(d!==null){d=(function(a,b,c){return b+(c?c.join(''):'')})(e,d[1],d[2])}if(d===null){n=e}return d}function parse_chars(){var c,result1;var d;d=n;result1=parse_char();if(result1!==null){c=[];while(result1!==null){c.push(result1);result1=parse_char()}}else{c=null}if(c!==null){c=(function(a,b){return b.join('')})(d,c)}if(c===null){n=d}return c}function parse_char(){var f,result1,result2,result3,result4;var g,pos1;g=n;if(/^[^{}\\\0-\x1F \t\n\r]/.test(h.charAt(n))){f=h.charAt(n);n++}else{f=null;if(o===0){matchFailed("[^{}\\\\\\0-\\x1F \\t\\n\\r]")}}if(f!==null){f=(function(a,x){return x})(g,f)}if(f===null){n=g}if(f===null){g=n;if(h.substr(n,2)==="\\#"){f="\\#";n+=2}else{f=null;if(o===0){matchFailed("\"\\\\#\"")}}if(f!==null){f=(function(a){return"\\#"})(g)}if(f===null){n=g}if(f===null){g=n;if(h.substr(n,2)==="\\{"){f="\\{";n+=2}else{f=null;if(o===0){matchFailed("\"\\\\{\"")}}if(f!==null){f=(function(a){return"\u007B"})(g)}if(f===null){n=g}if(f===null){g=n;if(h.substr(n,2)==="\\}"){f="\\}";n+=2}else{f=null;if(o===0){matchFailed("\"\\\\}\"")}}if(f!==null){f=(function(a){return"\u007D"})(g)}if(f===null){n=g}if(f===null){g=n;pos1=n;if(h.substr(n,2)==="\\u"){f="\\u";n+=2}else{f=null;if(o===0){matchFailed("\"\\\\u\"")}}if(f!==null){result1=parse_hexDigit();if(result1!==null){result2=parse_hexDigit();if(result2!==null){result3=parse_hexDigit();if(result3!==null){result4=parse_hexDigit();if(result4!==null){f=[f,result1,result2,result3,result4]}else{f=null;n=pos1}}else{f=null;n=pos1}}else{f=null;n=pos1}}else{f=null;n=pos1}}else{f=null;n=pos1}if(f!==null){f=(function(a,b,c,d,e){return String.fromCharCode(parseInt("0x"+b+c+d+e))})(g,f[1],f[2],f[3],f[4])}if(f===null){n=g}}}}}return f}function parse_digits(){var c,result1;var d;d=n;if(/^[0-9]/.test(h.charAt(n))){result1=h.charAt(n);n++}else{result1=null;if(o===0){matchFailed("[0-9]")}}if(result1!==null){c=[];while(result1!==null){c.push(result1);if(/^[0-9]/.test(h.charAt(n))){result1=h.charAt(n);n++}else{result1=null;if(o===0){matchFailed("[0-9]")}}}}else{c=null}if(c!==null){c=(function(a,b){return parseInt((b.join('')),10)})(d,c)}if(c===null){n=d}return c}function parse_hexDigit(){var a;if(/^[0-9a-fA-F]/.test(h.charAt(n))){a=h.charAt(n);n++}else{a=null;if(o===0){matchFailed("[0-9a-fA-F]")}}return a}function parse__(){var b,result1;var c;o++;c=n;b=[];result1=parse_whitespace();while(result1!==null){b.push(result1);result1=parse_whitespace()}if(b!==null){b=(function(a,w){return w.join('')})(c,b)}if(b===null){n=c}o--;if(o===0&&b===null){matchFailed("whitespace")}return b}function parse_whitespace(){var a;if(/^[ \t\n\r]/.test(h.charAt(n))){a=h.charAt(n);n++}else{a=null;if(o===0){matchFailed("[ \\t\\n\\r]")}}return a}function cleanupExpected(a){a.sort();var b=null;var c=[];for(var i=0;i<a.length;i++){if(a[i]!==b){c.push(a[i]);b=a[i]}}return c}function computeErrorPosition(){var a=1;var b=1;var c=false;for(var i=0;i<Math.max(n,p);i++){var d=h.charAt(i);if(d==="\n"){if(!c){a++}b=1;c=false}else if(d==="\r"||d==="\u2028"||d==="\u2029"){a++;b=1;c=true}else{b++;c=false}}return{line:a,column:b}}var r=m[l]();if(r===null||n!==h.length){var u=Math.max(n,p);var v=u<h.length?h.charAt(u):null;var y=computeErrorPosition();throw new this.SyntaxError(cleanupExpected(q),v,u,y.line,y.column);}return r},toSource:function(){return this._source}};z.SyntaxError=function(d,e,f,g,h){function buildMessage(a,b){var c,foundHumanized;switch(a.length){case 0:c="end of input";break;case 1:c=a[0];break;default:c=a.slice(0,a.length-1).join(", ")+" or "+a[a.length-1]}foundHumanized=b?quote(b):"end of input";return"Expected "+c+" but "+foundHumanized+" found."}this.name="SyntaxError";this.expected=d;this.found=e;this.message=buildMessage(d,e);this.offset=f;this.line=g;this.column=h};z.SyntaxError.prototype=Error.prototype;return z})();MessageFormat.prototype.parse=function(){return B.parse.apply(B,arguments)};MessageFormat.prototype.precompile=function(d){var e=this,needOther=false,fp={begin:'function(d){\nvar r = "";\n',end:"return r;\n}"};function interpMFP(b,c){c=c||{};var s='',i,tmp,lastkeyname;switch(b.type){case'program':return interpMFP(b.program);case'messageFormatPattern':for(i=0;i<b.statements.length;++i){s+=interpMFP(b.statements[i],c)}return fp.begin+s+fp.end;case'messageFormatPatternRight':for(i=0;i<b.statements.length;++i){s+=interpMFP(b.statements[i],c)}return s;case'messageFormatElement':c.pf_count=c.pf_count||0;s+='if(!d){\nthrow new Error("MessageFormat: No data passed to function.");\n}\n';if(b.output){s+='r += d["'+b.argumentIndex+'"];\n'}else{lastkeyname='lastkey_'+(c.pf_count+1);s+='var '+lastkeyname+' = "'+b.argumentIndex+'";\n';s+='var k_'+(c.pf_count+1)+'=d['+lastkeyname+'];\n';s+=interpMFP(b.elementFormat,c)}return s;case'elementFormat':if(b.key==='select'){s+=interpMFP(b.val,c);s+='r += (pf_'+c.pf_count+'[ k_'+(c.pf_count+1)+' ] || pf_'+c.pf_count+'[ "other" ])( d );\n'}else if(b.key==='plural'){s+=interpMFP(b.val,c);s+='if ( pf_'+(c.pf_count)+'[ k_'+(c.pf_count+1)+' + "" ] ) {\n';s+='r += pf_'+c.pf_count+'[ k_'+(c.pf_count+1)+' + "" ]( d ); \n';s+='}\nelse {\n';s+='r += (pf_'+c.pf_count+'[ MessageFormat.locale["'+e.fallbackLocale+'"]( k_'+(c.pf_count+1)+' - off_'+(c.pf_count)+' ) ] || pf_'+c.pf_count+'[ "other" ] )( d );\n';s+='}\n'}return s;case'pluralFormatPattern':c.pf_count=c.pf_count||0;s+='var off_'+c.pf_count+' = '+b.offset+';\n';s+='var pf_'+c.pf_count+' = { \n';needOther=true;for(i=0;i<b.pluralForms.length;++i){if(b.pluralForms[i].key==='other'){needOther=false}if(tmp){s+=',\n'}else{tmp=1}s+='"'+b.pluralForms[i].key+'" : '+interpMFP(b.pluralForms[i].val,(function(){var a=JSON.parse(JSON.stringify(c));a.pf_count++;return a})())}s+='\n};\n';if(needOther){throw new Error("No 'other' form found in pluralFormatPattern "+c.pf_count);}return s;case'selectFormatPattern':c.pf_count=c.pf_count||0;s+='var off_'+c.pf_count+' = 0;\n';s+='var pf_'+c.pf_count+' = { \n';needOther=true;for(i=0;i<b.pluralForms.length;++i){if(b.pluralForms[i].key==='other'){needOther=false}if(tmp){s+=',\n'}else{tmp=1}s+='"'+b.pluralForms[i].key+'" : '+interpMFP(b.pluralForms[i].val,(function(){var a=JSON.parse(JSON.stringify(c));a.pf_count++;return a})())}s+='\n};\n';if(needOther){throw new Error("No 'other' form found in selectFormatPattern "+c.pf_count);}return s;case'string':return'r += "'+MessageFormat.Utils.numSub(MessageFormat.Utils.escapeExpression(b.val),'k_'+c.pf_count+' - off_'+(c.pf_count-1),c.pf_count)+'";\n';default:throw new Error('Bad AST type: '+b.type);}}return interpMFP(d)};MessageFormat.prototype.compile=function(a){return(new Function('MessageFormat','return '+this.precompile(this.parse(a))))(MessageFormat)};if(typeof exports!=='undefined'){if(typeof module!=='undefined'&&module.exports){exports=module.exports=MessageFormat}exports.MessageFormat=MessageFormat}else if(typeof define==='function'&&define.amd){define(function(){return MessageFormat})}else{A['MessageFormat']=MessageFormat}})(this);